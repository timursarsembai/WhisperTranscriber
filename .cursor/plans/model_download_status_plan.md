# План: статус скачивания моделей и прогресс загрузки во вкладке «Транскрибация»

## Цель

- В списке моделей (tiny, base, small, medium, large-v3) показывать, какие модели **уже скачаны** на ПК, а какие **нет**.
- При клике на нескачанную модель — запускать загрузку и показывать **прогресс в процентах** (и при желании прогресс-бар).
- Пользователь понимает, что выбор нескачанной модели приведёт к загрузке.

## Текущее состояние

- **Список моделей**: в [main.py](e:\Development\faster_whisper\main.py) в `_build_settings_panel` (вкладка «Транскрибация») выводятся строки для каждой модели: название (tiny, base, …) и описание. Клик по строке вызывает `_pick_model(value)` и только меняет выбранную модель.
- **Загрузка модели**: выполняется при первом использовании (старт транскрипции или потоковая запись) в [TranscriptionService.py](e:\Development\faster_whisper\TranscriptionService.py): `WhisperModel(model_size, ..., download_root=models_dir)`. Каталог `models_dir` — либо `os.path.join(os.getcwd(), "models")`, либо рядом с exe. Внутри используется Hugging Face Hub: в `models_dir` появляются папки вида `models--Systran--faster-whisper-{size}`.
- **Проверка «скачана ли модель»**: можно использовать `huggingface_hub.scan_cache_dir(cache_dir)` — возвращает `HFCacheInfo` с `repos` (каждый repo: `repo_id`, `repo_path`). Маппинг размера на repo_id: `Systran/faster-whisper-tiny`, `-base`, `-small`, `-medium`, `-large-v3`.
- **Прогресс загрузки**: `faster_whisper.download_model()` внутри вызывает `huggingface_hub.snapshot_download(..., tqdm_class=disabled_tqdm)`, поэтому по умолчанию прогресс не отдаётся. Чтобы получить проценты, нужно вызывать `snapshot_download` напрямую с **кастомным классом tqdm**, который при обновлении (n, total и т.д.) вызывает callback и/или обновляет UI (например, через `self.after(0, lambda: ...)`).

---

## 1. Определение каталога кэша и списка скачанных моделей

- **Единый каталог кэша** должен совпадать с тем, что использует приложение при загрузке модели. Сейчас в `TranscriptionService.load_model()` задаётся `download_root=models_dir` и этот же путь передаётся в WhisperModel; Hugging Face использует его как `cache_dir` (или как `local_dir` в зависимости от версии). Нужно в коде явно считать: «каталог кэша моделей = тот же `models_dir`» (как в TranscriptionService: от `getcwd()` или от `dirname(executable)`).
- В **main.py** (или в отдельном хелпере/сервисе) реализовать функцию вида:
  - `get_models_cache_dir() -> str` — возвращает тот же путь, что и `TranscriptionService` (логику можно вынести в общий метод в TranscriptionService, например `get_cache_dir()`, чтобы не дублировать условия frozen/cwd).
- **Проверка «скачана ли модель»**:
  - Вызвать `huggingface_hub.scan_cache_dir(cache_dir)` (если такой функции нет в старой версии — запасной вариант: проверять наличие папки `models--Systran--faster-whisper-{size}` и внутри неё `snapshots/<hash>/model.bin` или аналог).
  - Маппинг: размер из UI (`tiny`, `base`, `small`, `medium`, `large-v3`) → `repo_id` = `Systran/faster-whisper-{size}`.
  - Результат: для каждого размера из списка моделей булево значение «скачана / не скачана».
- Вызывать эту проверку при открытии вкладки «Транскрибация» (или при показе панели настроек) и после завершения загрузки модели, чтобы обновить подписи.

---

## 2. Отображение статуса «Скачана» / «Не скачана» в списке моделей

- В [main.py](e:\Development\faster_whisper\main.py) в блоке, где для каждой модели создаётся `row_f` с `name_lbl` и `desc_lbl`, добавить третью строку (виджет):
  - **Статус-метка** (например, `CTkLabel`): текст «Скачана» или «Не скачана» (позже — ключи локализации, например `model.status.downloaded` / `model.status.not_downloaded`). Цвет можно разный (например, серый/зелёный для скачанной, оранжевый/серый для не скачанной).
- При инициализации списка моделей один раз вызвать функцию получения статусов по кэшу и для каждой строки установить соответствующий текст метки.
- Сохранить ссылки на эти метки (и при необходимости на контейнер для прогресса), например в словаре `_model_status_labels[model_id]` или внутри `_model_row_frames` (доп. виджеты в row_f), чтобы потом обновлять при загрузке и по завершении.

---

## 3. Загрузка модели по клику и отображение прогресса в процентах

- **Поведение при клике**:
  - Если модель **уже скачана** — оставить текущее поведение: только смена выбора (`_pick_model(value)`).
  - Если модель **не скачана** — не менять выбор сразу; запустить **фоновую загрузку** этой модели и показать в строке этой модели прогресс (текст «Загрузка X%» и опционально прогресс-бар).
- **Реализация загрузки с прогрессом**:
  - Не вызывать `faster_whisper.download_model()` напрямую (он отключает tqdm). Вызвать `huggingface_hub.snapshot_download(repo_id=..., cache_dir=get_models_cache_dir(), allow_patterns=..., tqdm_class=...)` с **кастомным классом tqdm** (наследник `tqdm`), который:
    - В методе обновления (например, при каждом `update(n)` или при изменении `n/total`) вычисляет процент и передаёт его в callback (или в очередь для главного потока).
  - Callback (выполняемый в главном потоке через `self.after(0, lambda: ...)`) обновляет для данной модели:
    - Текст статуса: «Загрузка N%» (и при желании — небольшой прогресс-бар под строкой).
  - Загрузку выполнять в **отдельном потоке** (thread), чтобы UI не подвисал.
  - По завершении загрузки (успех или ошибка) в главном потоке:
    - Успех: обновить статус на «Скачана», убрать прогресс-бар; можно автоматически выбрать эту модель (`_pick_model(value)`).
    - Ошибка: показать сообщение (messagebox или метка в строке) и вернуть статус «Не скачана».
- **Блокировка повторного запуска**: пока идёт загрузка одной модели, клики по другим нескачанным моделям можно игнорировать или показывать «Подождите, идёт загрузка другой модели» (по желанию — очередь загрузок).

---

## 4. Согласование с TranscriptionService

- Чтобы после загрузки через настройки модель подхватывалась без повторной загрузки, **каталог кэша** при вызове `snapshot_download` должен быть **тем же**, что и `download_root` в `TranscriptionService.load_model()`. Поэтому:
  - Либо в TranscriptionService добавить статический метод `get_models_dir()` (или `get_cache_dir()`), и в main.py + в самом TranscriptionService использовать его;
  - Либо в main.py дублировать ту же логику (frozen vs cwd) при вызове `scan_cache_dir` и `snapshot_download`. Предпочтительно вынести путь в одно место (TranscriptionService), чтобы не расходиться при изменении логики.

---

## 5. Локализация

- Добавить ключи, например:
  - `model.status.downloaded` — «Скачана» / «Downloaded»
  - `model.status.not_downloaded` — «Не скачана» / «Not downloaded»
  - `model.status.downloading` — «Загрузка…» (для подстановки «Загрузка 45%» через параметр или форматную строку)
- Использовать их в метках статуса и в тексте прогресса.

---

## 6. Порядок реализации (кратко)

1. **TranscriptionService**: добавить метод получения каталога моделей (например, `get_models_cache_dir()`) и при необходимости использовать его в `load_model()`.
2. **Проверка скачанных моделей**: функция (в main или в TranscriptionService), использующая `scan_cache_dir` и маппинг size → repo_id; возвращает словарь `{ model_id: bool }`.
3. **UI списка моделей**: добавить метку статуса (и место под прогресс-бар) для каждой модели; при построении панели вызвать проверку и выставить «Скачана»/«Не скачана».
4. **Загрузка с прогрессом**: поток + `snapshot_download` с кастомным tqdm и callback в главный поток; обновление метки/прогресс-бара; по завершении — обновить статус и при успехе опционально выбрать модель.
5. **Обработка клика**: в `_pick_model` или в обработчике клика по строке — если модель не скачана, запустить загрузку с прогрессом; если скачана — только смена выбора.
6. **Локализация**: ключи для статусов и строки «Загрузка N%».

---

## Зависимости и риски

- **Версия huggingface_hub**: `scan_cache_dir` есть не во всех старых версиях; при её отсутствии — запасной вариант: проверять наличие папки `models--Systran--faster-whisper-{size}` и файла внутри `snapshots/*/model.bin`.
- **tqdm в snapshot_download**: в разных версиях huggingface_hub прогресс может передаваться по-разному (по файлам или по байтам); кастомный tqdm нужно адаптировать под фактическую сигнатуру (например, переопределить `update(n=1)` и считать процент от общего числа файлов или от переданного total).
